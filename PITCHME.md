### 文字コードの基本

---

### 文字コードとは何か？

1. 文字集合と文字符号化方式の合わせたもの
2. 文字に対応するバイト列(ex. 文字コード表)

今回は1の意味を扱う

---

### 前置き
- シンプルにするために、多少用語を省略・統合する
    - 例: 「符号化文字集合」を単に「文字集合」と記述

---

### 文字集合
- ある文字コードで扱う文字の集合

---

### 文字符号化方式(=文字符号化スキーム)
- 文字集合の要素をバイト列に変換する方式
- 符号化形式
    - 例: **UTF-16**LEの`UTF-16`部分
- バイト直列化
    - 例: UTF-16**LE**の`LE`部分

---

### Unicode
- 文字集合と文字符号化方式の規格の1つ
- 狭義にはUnicode文字集合のことだけを指す
- UTF-16をUnicodeと呼んで人を混乱させようとしてるものがあるけど信じちゃダメだよ
    - Windowsのエディタとかね

---

### コードポイント
- Unicodeでは文字はコードポイントに割り当てられる
    - 例
        - U+0000 : `NULL`
        - U+0041 : `A`
        - U+29E3D: `𩸽` (魚偏に花: ホッケ)

---

### エンディアン
- LE: リトル・エンディアン
    - バイトの並びが逆順
    - `a`の2バイト表現: `60 00`
- BE: ビッグ・エンディアン
    - バイトの並びが正順
    - `a`の2バイト表現: `00 60`

- 補足
    - CPUのアーキテクチャ上、LEの方が効率が良いケースがあるの
    - OSレベルのメモリアドレス表現もLEだったりする

---

### Unicodeの文字符号化方式(1)
- UTF-7
    - 覚えなくていいです(少なくとも私は覚える気ないです)
- UTF-8
    - 皆が好きなやつ
    - 1バイト文字はASCIIと互換性あり
    - 1～6バイトで文字を表現
    - BOM(偽物)が付くことがある
- UTF-32
    - 唯一の固定長スキーム
    - LEとBEがありBOMで識別する

### Unicodeの文字符号化方式(2): UTF-16シリーズ
- 元々Unicodeは16bitで世界の全文字を表現されると妄想されてたので、UTF-16が唯一のUnicodeだった
- が、そんなことなかった
    - もしかして: サロゲートペア(後述)
- 種類
    - UTF-16: LEとBEがありBOMで識別する
    - UTF-16LE: BOMは使用不可で必ずLE
    - UTF-16BE: BOMは使用不可で必ずBE

### BOM(Byte Order Mark)
- エンディアンを識別するための文字列の先頭に付くバイト列
- UTF-16
    - LE: `FF FE`
    - BE: `FE FF`
- UTF-32
    - LE: `FF FE 00 00`
    - BE: `00 00 FE FF`

---

### UTF-8のBOM
- UTF-8はその性質上、BOMは不要
- つまり、BOMじゃない
- 規格上、UTF-8であることを示すためにBOMの位置に次のバイト列を付けても良いことになっている
    - `EF BB BF`
- Windows系で良く付けられる
- Unix系の一部ツールではこれを認識できずに文字化けする

---

### サロゲートペア
- 背景
    1. 16ビット(2^16 = 65,536)で世界の文字全部収録できるやろ
    2. さーせん、収まりませんでした 
        - 0x10000以降のコードポイントの文字が発生
        - だいたい漢字のせい
    3. 16ビットから拡張しないと…でも既存システムもあるし…
    4. そうだ、2バイト×2の組み合わせで表現しよう
        - 未使用だったU+D800～U+DFFFの組み合わせで文字を表現
※ sarrogate = 代理人、代用物

---

### サロゲートペア補足
- 直接関係あるのはUTF-16
- なんだけどサロゲートペアを扱うためにサロゲートコードポイントが定義されているので、他のスキームもとばっちりは受けてる

---

### Unicode以外の文字コード
- Shift_JIS
    - 悪い文明(暴言)
    - `だめ文字`, `5C Shift_JIS`, `表 Shift_JIS` などで検索
- cp932
    - Shift_JISのベンダ独自実装
    - MS, IBM…いろいろなベンダが好きに実装
    - ほぼWindows-31Jを指す言葉
- EUC-JP
    - よく知らない

---

### おまけ: 改行コード
- 文字コードとは直接関係ないけど…
- 種類
    - LF(Unix系)
    - CR(旧Mac、今は使われていない)
    - CRLF(Windows)
- GitをWindowsにインストールしたときにトラブルのタネになるので注意

---

### 参考書籍・リンク
- [Joel on Software](http://amzn.asia/2Y3vVte)
    - すべてのソフトウェア開発者が絶対確実に知っていなければならないUnicodeとキャラクタセットに関する最低限のこと(言い訳なし！)
    - [Webの和訳版](https://www.supinf.co.jp/tech/2014/12/03/joel-unicode/)
- [Unicode のサロゲートペアとは何か](http://vividcode.hatenablog.com/entry/unicode/surrogate-pair)
- [本当は怖くないCP932](https://qiita.com/kasei-san/items/cfb993786153231e5413)
